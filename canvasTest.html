<html>
<head>
<link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap.min.css" />
</head>
<body>
<canvas style="border:1px solid" width="1000" height="600"></canvas><br>
<button class="btn">Fullscreen</button>
<button class="btn">Remove Sun</button>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="http://blueimp.github.com/cdn/js/bootstrap.js"></script>
<script>
(function(){
	Array.prototype.remove = function(from, to) {
		var rest = this.slice((to || from) + 1 || this.length);
		this.length = from < 0 ? this.length + from : from;
		return this.push.apply(this, rest);
	};
	function drawCircle(ctx, x, y, r){
		ctx.beginPath();
		ctx.arc(x, y, r, 0, Math.PI * 2);
	};
	function drawEllipse(ctx, x, y, xr, yr){
	  var kappa = .5522848;
		  ox = xr * kappa, // control point offset horizontal
		  oy = yr * kappa, // control point offset vertical
		  xe = x + xr;       // x-end
		  ye = y + yr,       // y-end
		  xs = x - xr,       // x-start
		  ys = y - yr;       // y-start

	  ctx.beginPath();
	  ctx.moveTo(xs, y);
	  ctx.bezierCurveTo(xs, y - oy, x - ox, ys, x, ys);
	  ctx.bezierCurveTo(x + ox, ys, xe, y - oy, xe, y);
	  ctx.bezierCurveTo(xe, y + oy, x + ox, ye, x, ye);
	  ctx.bezierCurveTo(x - ox, ye, xs, y + oy, xs, y);
	  ctx.closePath();
	};
	CanvasRenderingContext2D.prototype.strokeCircle = function(x, y, radius){
		drawCircle(this, x, y, radius);
		this.stroke();
	};
	CanvasRenderingContext2D.prototype.fillCircle = function(x, y, radius){
		drawCircle(this, x, y, radius);
		this.fill();
	};
	CanvasRenderingContext2D.prototype.strokeEllipse = function(x, y, xr, yr) {
		drawEllipse(this, x, y, xr, yr);
		this.stroke();
	};
	CanvasRenderingContext2D.prototype.fillEllipse = function(x, y, xr, yr) {
		drawEllipse(this, x, y, xr, yr);
		this.fill();
	};
	Function.prototype.extend = function() {
		function Class() {
			if (!(this instanceof Class))
				throw('Constructor called without "new"');
			if ('_init' in this)
				this._init.apply(this, arguments);
		}
		Function.prototype.extend.nonconstructor.prototype = this.prototype;
		Class.prototype = new Function.prototype.extend.nonconstructor();
		return Class;
	};
	Function.prototype.extend.nonconstructor= function() {};
})();
window.onload = function(){
	// -----------------
	// Define Components
	// -----------------
	var GameObject = Object.extend();
	GameObject.prototype._init = function(x, y){
		this.components = [];
		this.x = x;
		this.y = y;
		this.vx = 0;
		this.vy = 0;
		this.lastVx = 0;
		this.lastVy = 0;
	};
	GameObject.prototype.addComponent = function(component){
		if(component instanceof GameComponent)
			this.components.push(component);
	};
	GameObject.prototype.update = function(delta){
		var i = 0,
			l = this.components.length;
		for(;i<l;i++)
			this.components[i].update(this, delta);
	};
	var GameObjectManager = GameObject.extend();
	GameObjectManager.prototype._init = function(){
		this.objects = [];
	};
	GameObjectManager.prototype.addObject = function(object){
		if(object instanceof GameObject)
			this.objects.push(object);
	};
	GameObjectManager.prototype.removeObject = function(object){
		if(!object instanceof GameObject)
			return;
		var i = 0,
			l = this.objects.length;
		for(;i<l;i++){
			if(this.objects[i] == object){
				this.objects.remove(i);
				return;
			}
		}
	};
	GameObjectManager.prototype.update = function(delta){
		var i = 0,
			l = this.objects.length;
		for(;i<l;i++)
			this.objects[i].update(delta);
	};
	var CanvasManager = GameObject.extend();
	CanvasManager.prototype._init = function(context){
		this.context = context;
	};
	CanvasManager.prototype.update = function(delta){
		this.context.fillStyle = "#fff";
		this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height);
	}
	var GameComponent = Object.extend();
	GameComponent.prototype.update = function(parent, delta){};
	var MoveComponent = GameComponent.extend();
	MoveComponent.prototype.update = function(parent, delta) {
		if(parent.vx)
			parent.x += parent.vx * delta;
		if(parent.vy)
			parent.y += parent.vy * delta;
	};
	var DrawComponent = GameComponent.extend();
	DrawComponent.prototype._init = function(context, size, colour){
		this.context = context;
		this.size = size;
		this.colour = colour;
	};
	DrawComponent.prototype.update = function(parent, delta) {
		this.context.fillStyle = this.colour;
		this.context.fillCircle(parent.x,parent.y,this.size);
		this.context.fillStyle = "rgba(255,255,255,0.7)";
		this.context.fillCircle(parent.x+this.size*0.33,parent.y-this.size*0.33,this.size*0.45);
		this.context.strokeStyle = "rgba(0,128,255,0.7)";
		this.context.beginPath();
		this.context.moveTo(parent.x, parent.y);
		this.context.lineTo(parent.x+parent.vx*100, parent.y+parent.vy*100);
		this.context.stroke();
		var ax = (parent.vx - parent.lastVx)/delta,
			ay = (parent.vy - parent.lastVy)/delta;
		parent.lastVx = parent.vx;
		parent.lastVy = parent.vy;
		this.context.strokeStyle = "rgba(0,255,0,0.7)";
		this.context.beginPath();
		this.context.moveTo(parent.x, parent.y);
		this.context.lineTo(parent.x+ax*4e5, parent.y+ay*4e5);
		this.context.stroke();
	};
	var BounceComponent = GameComponent.extend();
	BounceComponent.prototype._init = function(width, height, roomWidth, roomHeight) {
		this.ax = width / 2;
		this.ay = height / 2;
		this.bx = roomWidth - this.ax;
		this.by = roomHeight - this.ay;
	};
	BounceComponent.prototype.update = function(parent, delta) {
		var coef = 0.9;
		if(parent.x < this.ax){
			parent.x = this.ax;
			parent.vx = -parent.vx*coef;
		}
		if(parent.x > this.bx){
			parent.x = this.bx;
			parent.vx = -parent.vx*coef;
		}
		if(parent.y < this.ay){
			parent.y = this.ay;
			parent.vy = -parent.vy*coef;
		}
		if(parent.y > this.by){
			parent.y = this.by;
			parent.vy = -parent.vy*coef;
		}
	};
	var GravityComponent = GameComponent.extend();
	GravityComponent.prototype.update = function(parent, delta) {
		if(typeof parent.vy == "undefined")
			parent.vy = 0;
		parent.vy += 0.0001*delta;
	};
	var RandomMoveComponent = GameComponent.extend();
	RandomMoveComponent.prototype.update = function(parent, delta) {
		if(Math.random()<0.001){
			parent.vx = Math.random()-0.5;
			parent.vy = Math.random()-0.5;
		}
	};
	var PointGravityComponent = GameComponent.extend();
	PointGravityComponent.prototype._init = function(object) {
		this.object = object;
	};
	PointGravityComponent.prototype.update = function(parent, delta) {
		var dx = this.object.x - parent.x,
			dy = this.object.y - parent.y,
			theta = Math.atan2(dx, dy);
		parent.vx += Math.sin(theta)*0.0001*delta;
		parent.vy += Math.cos(theta)*0.0001*delta;
	};

	// -----------------
	// Create Game Graph
	// -----------------
	var ctx = document.getElementsByTagName('canvas')[0].getContext('2d'),
		gameRoot = new GameObjectManager(),
		width = ctx.canvas.width,
		height = ctx.canvas.height,
		ballSize = 4,
    	// Normal dist between -1 and 1
	    random = function(sd, mean){
	        var d=10, r=0, i=0;
	        for(;i<d;i++)
	            r += Math.random();
	        r = r / d * 2 - 1;
	        if(typeof sd != "undefined" &&
	            typeof mean != "undefined")
	            r = sd * r + mean;
	        return r;
	    }
	gameRoot.addObject(new CanvasManager(ctx));
	var massiveObject1 = new GameObject(width * 1 / 3, height / 2);
	massiveObject1.vy = 0.08;
	massiveObject1.addComponent(new DrawComponent(ctx, 12, "#ff0"));
	massiveObject1.addComponent(new MoveComponent());
	gameRoot.addObject(massiveObject1);
	var massiveObject2 = new GameObject(width * 2 / 3, height / 2);
	massiveObject2.vy = -0.08;
	massiveObject2.addComponent(new DrawComponent(ctx, 12, "#ff0"));
	massiveObject2.addComponent(new PointGravityComponent(massiveObject1));
	massiveObject1.addComponent(new PointGravityComponent(massiveObject2));
	massiveObject2.addComponent(new MoveComponent());
	gameRoot.addObject(massiveObject2);
	for(var i = 0; i < 50; i++){
		var redBall = new GameObject(
			random(width, width / 2),
			random(height, height / 2)
		);
		redBall.vx = Math.random()-0.5;
		redBall.vy = Math.random()-0.5;
		//redBall.addComponent(new RandomMoveComponent());
		redBall.addComponent(new PointGravityComponent(massiveObject1));
		redBall.addComponent(new PointGravityComponent(massiveObject2));
		//redBall.addComponent(new BounceComponent(ballSize, ballSize, width, height));
		redBall.addComponent(new MoveComponent());
		redBall.addComponent(new DrawComponent(ctx, ballSize, "#f00"));
		gameRoot.addObject(redBall);
	}

	// --------------------
	// Main Game Control
	// --------------------
	var lastTime = 0;
	function loop(t){
		var delta = Math.min(t - lastTime, 1000);
		gameRoot.update(delta);
		lastTime = t;
		requestAnimationFrame(loop);
	}
	requestAnimationFrame(loop);

	// -----
	// UI
	// -----
	document.getElementsByTagName('button')[0].onclick = function(){
		ctx.canvas.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
	};
	document.getElementsByTagName('button')[1].onclick = function(){
		gameRoot.removeObject(massiveObject2);
	};
}
</script>
</html>